import{r as p}from"./config-adf52b6e.js";import{i as h,g as W}from"./job-22d73a77.js";import{t as s}from"./translate-a92a2393.js";import{t as c}from"./layers-6eae4c33.js";import{g as v}from"./firebase-f59070e7.js";import{i as C}from"./secretPassages-aa431cd6.js";import{o as b,t as m}from"./discussionv2-8cccfd78.js";import{n as S}from"./notifications-bb73e947.js";import{i as g,a as u,h as a,b as y,p as d}from"./sounds-131a2a9b.js";import{h as w}from"./workadventureFeatures-48ab46db.js";import{o as B}from"./init-ea23a5cf.js";import{d as k,a as P,b as F}from"./ui-ca9d2579.js";let n=null,t=null;const L=async()=>{const e=await WA.player.getPosition();WA.camera.set(e.x,e.y,100,100)},x="bomb";B(x).then(async()=>{k(),P(),F(),WA.camera.followPlayer(!0),WA.camera.set(665,838),await h(),w(),g([{name:"evilGuySound",path:"evilGuy.mp3"}]);let e;v().then(o=>{(o==null?void 0:o.choice)!="online"&&(e=WA.sound.loadSound(`${p}/sounds/bomb.mp3`),e.play({volume:.1,loop:!1,rate:1,detune:1,delay:0,seek:0,mute:!1}))}),L();const i=await W();b(m.mySelf,`bomb.story.${i}`,"views.choice.close","discussion",()=>{a("freeSpy")?(c("rock",!1),WA.room.setTiles([{x:15,y:7,tile:null,layer:"rockCollisions"},{x:15,y:8,tile:null,layer:"rockCollisions"}])):i==="spy"&&(WA.state.difused==!1&&WA.controls.disablePlayerControls(),WA.player.setOutlineColor(255,0,0))}),WA.player.state.askForDefuseBomb=!1,WA.player.state.askForBoom=!1,WA.state.onVariableChange("difused").subscribe(o=>{o&&f()}),C(["secretPassage"],[()=>{console.info("secret passage discovered !")}]),u("freeSpy",()=>{c("rock",!1),WA.room.setTiles([{x:15,y:7,tile:null,layer:"rockCollisions"},{x:15,y:8,tile:null,layer:"rockCollisions"}]),i==="spy"&&(WA.player.removeOutlineColor(),WA.controls.restorePlayerControls())}),u("boom",()=>{e==null||e.stop(),WA.ui.actionBar.removeButton("cheatSheetButton"),d("evilGuySound"),b(m.bombFailure,"bomb.bomb.failure.message","views.choice.close","discussion",async()=>{i==="spy"&&WA.controls.disablePlayerControls()})}),u("defuseBomb",()=>{c("bomb",!1),f(),e==null||e.stop(),WA.ui.actionBar.removeButton("cheatSheetButton"),d("successSound"),S(s("bomb.bomb.success"),s("utils.success"),"success"),WA.state.difused=!0}),i==="spy"&&(WA.player.state.askForCloseCheatSheet=!1,WA.ui.actionBar.addButton({id:"cheatSheetButton",label:s("bomb.cheatSheet"),callback:async()=>{t?A():await E()}}),WA.player.state.onVariableChange("askForCloseCheatSheet").subscribe(o=>{o&&A()}));let l=null;WA.room.onEnterLayer("saveSpyZone").subscribe(()=>{!a("boom")&&!a("defuseBomb")?b(m.mySelf,"bomb.freeSpy.noTime","views.choice.close","discussion"):a("freeSpy")||(l=WA.ui.displayActionMessage({message:s("utils.executeAction",{action:s("bomb.freeSpy.free")}),callback:()=>{y("freeSpy")}}),WA.room.onLeaveLayer("saveSpyZone").subscribe(()=>{l==null||l.remove(),l=null}))});let r=null;WA.room.onEnterLayer("bombZone").subscribe(()=>{!a("boom")&&!a("defuseBomb")&&(r=WA.ui.displayActionMessage({message:s("utils.executeAction",{action:s("bomb.bomb.defuse")}),callback:async()=>{WA.state.difused==!1&&WA.controls.disablePlayerControls(),n=await WA.ui.website.open({url:`${p}/views/bomb/bomb.html`,allowApi:!0,allowPolicy:"",position:{vertical:"middle",horizontal:"middle"},size:{height:"50vh",width:"50vw"}})}})),WA.room.onLeaveLayer("bombZone").subscribe(()=>{r==null||r.remove(),r=null})}),WA.player.state.onVariableChange("askForBoom").subscribe(o=>{o&&(f(),y("boom"))}),WA.player.state.onVariableChange("askForDefuseBomb").subscribe(o=>{o&&y("defuseBomb")})});const E=async()=>{t=await WA.ui.website.open({url:`${p}/views/bomb/cheatSheet.html`,allowApi:!0,allowPolicy:"",position:{vertical:"middle",horizontal:"middle"},size:{height:"50vh",width:"50vw"}})},A=()=>{t==null||t.close(),t=null,WA.player.state.askForCloseCheatSheet=!1},f=()=>{n&&(n.close(),n=null),WA.controls.restorePlayerControls()};
